name: ğŸš€ Auto Deploy to EC2 (Housekeeping Backend)

on:
  push:
    branches: ["master"]      # If your main branch is "main", change it
  workflow_dispatch:

jobs:
  deploy:
    runs-on:
      - self-hosted
      - Linux
      - X64

    env:
      DEPLOY_DIR: /home/ubuntu/housekeeping-backend
      APP_NAME: housekeeping-backend

      # App runtime env
      NODE_ENV: production
      PORT: 3005
      LOG_LEVEL: info

      # DB SECRETS
      PG_HOST: ${{ secrets.PG_HOST }}
      PG_PORT: 5432
      PG_USER: ${{ secrets.PG_USER }}
      PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
      PG_DATABASE: ${{ secrets.PG_DATABASE }}
      PG_SSL: true

      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRES_IN: 30d

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸŸ¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: "ğŸ“¦ Install Dependencies (CI workspace)"
        run: npm ci

      - name: "ğŸ§ª Build if build script exists"
        run: |
          if npm run | grep -q "build"; then
            echo "ğŸš€ Running build..."
            npm run build
          else
            echo "â„¹ï¸ No build script found. Skipping build."
          fi

      - name: "ğŸ“‚ Sync Code to EC2 Deploy Directory"
        run: |
          echo "Syncing project to EC2 deploy directory..."
          mkdir -p "$DEPLOY_DIR"
          rsync -av --delete \
            --exclude ".git" \
            --exclude "node_modules" \
            ./ "$DEPLOY_DIR"/

      - name: "ğŸ” Generate .env File in EC2 Deploy Directory"
        run: |
          cd "$DEPLOY_DIR"
          cat <<EOF > .env
NODE_ENV=${NODE_ENV}
PORT=${PORT}
LOG_LEVEL=${LOG_LEVEL}

PG_HOST=${PG_HOST}
PG_PORT=${PG_PORT}
PG_USER=${PG_USER}
PG_PASSWORD=${PG_PASSWORD}
PG_DATABASE=${PG_DATABASE}
PG_SSL=${PG_SSL}

JWT_SECRET=${JWT_SECRET}
JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
EOF

      - name: "ğŸš€ Start / Restart with PM2"
        run: |
          cd "$DEPLOY_DIR"

          echo "ğŸ“¦ Installing production dependencies..."
          npm ci --omit=dev

          if ! command -v pm2 >/dev/null 2>&1; then
            echo "ğŸ“Œ Installing PM2..."
            sudo npm install -g pm2
          fi

          if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
            echo "ğŸ” Restarting existing PM2 process..."
            pm2 restart "$APP_NAME" --update-env
          else
            echo "âœ¨ Starting new PM2 process..."
            pm2 start src/server.js --name "$APP_NAME"
          fi

          pm2 save || true
          pm2 status
