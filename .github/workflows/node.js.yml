name: "üöÄ Node.js CI & Deploy to EC2"

on:
  push:
    branches: ["master"]   # agar aapka branch "main" hai to yahan main likho
  workflow_dispatch:

jobs:
  deploy:
    runs-on:
      - self-hosted
      - Linux
      - X64

    env:
      RUNNER_TEMP: /home/ubuntu/actions-runner/_temp
      RUNNER_TOOL_CACHE: /home/ubuntu/actions-runner/_tool
      DEPLOY_DIR: /home/ubuntu/housekeeping-backend
      APP_NAME: housekeeping-backend

      NODE_ENV: production
      PORT: 3005
      LOG_LEVEL: info

      # ---- Main DB (PG_*) ----
      PG_HOST: ${{ secrets.PG_HOST }}
      PG_PORT: 5432
      PG_USER: ${{ secrets.PG_USER }}
      PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
      PG_DATABASE: ${{ secrets.PG_DATABASE }}
      PG_SSL: true

      # ---- (Optional) Second DB alias (agar code me use hota ho) ----
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: 5432
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_SSL: true

      # ---- Auth ----
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRES_IN: 30d

      # ---- Maytapi (WhatsApp) ----
      MAYTAPI_PRODUCT_ID: ${{ secrets.MAYTAPI_PRODUCT_ID }}
      MAYTAPI_PHONE_ID: ${{ secrets.MAYTAPI_PHONE_ID }}
      MAYTAPI_TOKEN: ${{ secrets.MAYTAPI_TOKEN }}
      MAYTAPI_GROUP_ID: ${{ secrets.MAYTAPI_GROUP_ID }}

    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4

      - name: "üõ† Prepare temp/cache dirs"
        run: |
          mkdir -p "$RUNNER_TEMP" "$RUNNER_TOOL_CACHE"

      - name: "üü¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: "üì¶ Install dependencies (CI workspace)"
        run: npm ci

      - name: "üß™ Build (if script exists)"
        run: |
          if node -e "const p=require('./package.json'); process.exit(p?.scripts?.build ? 0 : 1)"; then
            echo "‚úÖ Build script ‡§Æ‡§ø‡§≤‡§æ, npm run build ‡§ö‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            npm run build
          else
            echo "‚ÑπÔ∏è Build script ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, build step skip ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§"
          fi

      - name: "üìÇ Sync code to deploy directory"
        run: |
          echo "Syncing code to $DEPLOY_DIR ..."
          mkdir -p "$DEPLOY_DIR"
          rsync -av --delete --exclude '.git' --exclude 'node_modules' ./ "$DEPLOY_DIR"/

      - name: "üöÄ Deploy with PM2 (src/server.js)"
        shell: bash
        run: |
          set -e

          if ! command -v pm2 >/dev/null 2>&1; then
            echo "PM2 ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, install ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            sudo npm i -g pm2
          fi

          cd "$DEPLOY_DIR"

          echo "Writing .env from workflow secrets..."
          # ‚ö†Ô∏è Yahan quotes NAHI honi chahiye, taaki variables expand ho saken
          cat << EOF > .env
NODE_ENV=${NODE_ENV}
PORT=${PORT}
LOG_LEVEL=${LOG_LEVEL}

PG_HOST=${PG_HOST}
PG_PORT=${PG_PORT}
PG_USER=${PG_USER}
PG_PASSWORD=${PG_PASSWORD}
PG_DATABASE=${PG_DATABASE}
PG_SSL=${PG_SSL}

DB_HOST=${DB_HOST}
DB_PORT=${DB_PORT}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
DB_NAME=${DB_NAME}
DB_SSL=${DB_SSL}

JWT_SECRET=${JWT_SECRET}
JWT_EXPIRES_IN=${JWT_EXPIRES_IN}

MAYTAPI_PRODUCT_ID=${MAYTAPI_PRODUCT_ID}
MAYTAPI_PHONE_ID=${MAYTAPI_PHONE_ID}
MAYTAPI_TOKEN=${MAYTAPI_TOKEN}
MAYTAPI_GROUP_ID=${MAYTAPI_GROUP_ID}
EOF

          echo "üì¶ Installing production dependencies in $DEPLOY_DIR ..."
          npm ci --omit=dev

          if pm2 describe "${APP_NAME}" >/dev/null 2>&1; then
            echo "üåÄ Existing PM2 process ‡§Æ‡§ø‡§≤‡§æ, RESTART ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            pm2 restart "${APP_NAME}" --update-env
          else
            echo "‚ú® PM2 process ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, ‡§®‡§Ø‡§æ start ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‚Ä¶"
            pm2 start src/server.js --name "${APP_NAME}"
          fi

          pm2 save || true

          echo "‚úÖ PM2 status:"
          pm2 status
